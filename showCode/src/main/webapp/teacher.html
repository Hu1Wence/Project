<!DOCTYPE html>
<html>

<head>

    <meta charset="UTF-8">
    <title>教师页面</title>
    <style type="text/css" media="screen">
        .div1 {
            text-align: center;
            font-size: 1.75rem
        }

        #editor {
            width: 100%;
            padding-bottom: 10%;
        }

        .top {
            /* 设置宽度高度背景颜色 */
            height: 50px;
            width: 100%;
            background: rgb(189, 181, 181);
            position: fixed; /*固定在顶部*/
            top: 0; /*离顶部的距离为0*/
        }

        .top ul {
            /* 清除ul标签的默认样式 */
            width: 80%;
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;

        }

        .top li {
            float: left; /* 使li内容横向浮动，即横向排列  */
            margin-right: 50px; /* 两个li之间的距离*/
        }

        .top li a {
            /* 设置链接内容显示的格式*/
            display: block; /* 把链接显示为块元素可使整个链接区域可点击 */
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none; /* 去除下划线 */
        }

        .top li a:hover {
            /* 鼠标选中时背景变为黑色 */
            background-color: #111;
        }
    </style>

</head>
<body>

<div id="app">
    <div class="top">

        <ul>
            <li><a href="http://120.27.192.235:8080/showCode/teacher.html">写代码</a></li>
            <li><a href="http://120.27.192.235:8080/showCode/choice.html">选择题</a></li>

        </ul>

    </div>
    <br>
    <hr>
    <div class="div1">
        <h3>请在下方查看学生编辑的代码或推送代码</h3>
    </div>
    <hr>
    <br>
    <form>
        <select style="font-size: 1.75rem; width: 200px " v-model="language" v-on:change="changeLanguage()">
            <option>cpp</option>
            <option>java</option>
        </select>
    </form>
    <div id="editor" style="min-height:400px">
        <textarea style="width: 100%; height: 800px "></textarea>
    </div>
    <div>
        <button style="font-size:27px;background-color: rgb(244,244,244);"
                v-on:click="sendCodeToStudent">推送学生代码模版:
        </button><span style="font-size:27px">{{sendCode}}</span>
    </div>

    <button style="font-size:27px;background:white" v-on:click = "getStuState">获取当前学生状态:</button><span style="font-size:27px">{{studentState}}</span>
    <div style="font-size:27px;background: grey">学生端链接:{{studentUrl}}</div>
</div>


<!-- 开发环境版本，包含了有帮助的命令行警告 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
<script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/ace/1.2.9/ace.js" type="text/javascript" charset="UTF-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.9/ext-language_tools.js" type="text/javascript"
        charset="utf-8"></script>
<script type="text/javascript" src="https://cdn.goeasy.io/goeasy-1.0.3.js"></script>

<script>

    var app = new Vue({
        el: "#app",
        data: {
            language: "java",
            studentUrl: "",
            studentState: "",
            sendCode:"",
            studentChoiceUrl: ""
        },
        methods: {
            init() {
                this.language = "java";
                Vue.prototype.$channelName = new Date().getTime();

                this.studentUrl = "http://120.27.192.235:8080/showCode/student.html?channelName=" + this.$channelName;

                // editor 为一个全局变量
                Vue.prototype.$editor = ace.edit("editor"),
                    // ace 初始化操作
                    this.$editor.setOptions({
                        enableBasicAutocompletion: true,
                        enableSnippets: true,
                        enableLiveAutocompletion: true,
                    });
                this.$editor.setTheme("ace/theme/twilight");
                this.$editor.session.setMode("ace/mode/java");
                this.$editor.resize();
                document.getElementById('editor').style.fontSize = '30px';
                this.$editor.setValue("// 请编写代码");
                this.$editor.getSession().selection.clearSelection();

                Vue.prototype.$websocket = new WebSocket("ws://120.27.192.235:8080/showCode/websocket");

                this.$websocket.onerror = function () {
                    alert("WebSocket连接错误");
                };

                this.$websocket.onopen = function () {
                    console.log("WebSocket连接成功");
                    console.log("studentChannel" + Vue.prototype.$channelName + "-subscribe");
                    Vue.prototype.$websocket.send("studentChannel" + Vue.prototype.$channelName + "-subscribe");
                    console.log("studentResp" + Vue.prototype.$channelName + "-subscribe");
                    Vue.prototype.$websocket.send("studentResp" + Vue.prototype.$channelName+ "-subscribe");
                };

                this.$websocket.onmessage = function (event) {
                    console.log(event.data);
                    if (event.data.split(Vue.prototype.$channelName+"-")[0] == "studentChannel") {
                        console.log(event.data);
                        var data1 = JSON.parse(event.data.split(Vue.prototype.$channelName+"-")[1]);
                        console.log(data1);
                        Vue.prototype.$editor.setValue(data1.code);
                        Vue.prototype.$editor.getSession().selection.clearSelection();
                        Vue.prototype.$editor.moveCursorToPosition(data1.cursor);
                    } else if (event.data.split("-")[0] == "stuState") {
                        console.log(event.data);
                        app.studentState = event.data.split("-")[1];
                    } else if(event.data.split(Vue.prototype.$channelName+"-")[0] == "studentResp") {
                        console.log(event.data);
                        app.sendCode = event.data.split(Vue.prototype.$channelName+"-")[1];
                    }

                };

                this.$websocket.onclose = function () {
                    alert("WebSocket连接关闭");
                };

                window.onbeforeunload = function () {
                    closeWebSocket();
                };


                function closeWebSocket() {
                    Vue.prototype.$websocket.close();
                }

                // 加载本地配置
                this.loadConfig();
                console.log("init done");
            },


            sendCodeToStudent() {
                this.sendCode = "代码同步中...";
                var code = this.$editor.getValue();
                var channel1 = "teacherChannel" + Vue.prototype.$channelName;
                console.log(channel1+"-" + code);
                Vue.prototype.$websocket.send(channel1 + "-" + code);
            },

            getStuState() {
                console.log("getStudentState");
                Vue.prototype.$websocket.send("getStudentState");
            },

            changeLanguage() {
                if (this.language == "java") {
                    Vue.prototype.$editor.session.setMode("ace/mode/java");
                    console.log("java")
                } else if (this.language == "cpp") {
                    Vue.prototype.$editor.session.setMode("ace/mode/c_cpp");
                    console.log("cpp")
                }

                localStorage.setItem("language", this.language);
                // 更新 url
                this.studentUrl = "http://120.27.192.235:8080/showCode/student.html?channelName=" + this.$channelName

            },

            loadConfig() {
                this.changeLanguage();
            }
        }
    });
    app.init()
</script>
</body>
</html>